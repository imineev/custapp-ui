/**
 * Copyright (c) 2014, 2016, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
define(["ojs/ojcore","jquery","ojs/ojdatasource-common","ojs/ojmodel"],function(b){b.Cf=function(b,a,d,c,e){this.cK=b;this.Sa=a;this.HT=[];this.AD=d;this.start=c<a.length?c:a.length-1;this.count=-1===e?a.length:Math.min(a.length,e)};o_("CollectionNodeSet",b.Cf,b);b.Cf.prototype.XW=function(b){this.O1(this).then(function(){b.success&&b.success()})};b.Cf.prototype.O1=function(b){return new Promise(function(a){function d(e){e<c?b.Gea(e,{success:function(a){null!==a?b.O1(a).then(function(){d(e+1)}):d(e+
1)}}):a(void 0)}var c=b.getCount();d(0)})};b.Cf.prototype.Gea=function(b,a){var d=this.Sa.at(b);if(this.AD.oy(d).leaf)this.HT[b]=null,a.success(null);else{var c=this.AD.GD(d),d=this.AD.oy(d).key,e=this;this.AD.Jy(c,0,-1,{success:function(c){e.HT[b]=c;a.success(c)}},d)}};b.Cf.prototype.getParent=function(){return this.cK};b.b.g("CollectionNodeSet.prototype.getParent",{getParent:b.Cf.prototype.getParent});b.Cf.prototype.getStart=function(){return this.start};b.b.g("CollectionNodeSet.prototype.getStart",
{getStart:b.Cf.prototype.getStart});b.Cf.prototype.getCount=function(){return this.count};b.b.g("CollectionNodeSet.prototype.getCount",{getCount:b.Cf.prototype.getCount});b.Cf.prototype.getData=function(b){this.AN(b);return this.Sa.at(b).attributes};b.b.g("CollectionNodeSet.prototype.getData",{getData:b.Cf.prototype.getData});b.Cf.prototype.AN=function(b){if(b<this.start||b>this.start+this.count)throw"Out of range";};b.Cf.prototype.getMetadata=function(b){this.AN(b);var a={};b=this.Sa.at(b);b=this.AD.oy(b);
a.key=b.key;a.leaf=b.leaf;a.depth=b.depth;return a};b.b.g("CollectionNodeSet.prototype.getMetadata",{getMetadata:b.Cf.prototype.getMetadata});b.Cf.prototype.dh=function(b){this.AN(b);return this.HT[b]};b.b.g("CollectionNodeSet.prototype.getChildNodeSet",{dh:b.Cf.prototype.dh});b.$a=function(f){f=f||{};this.qD=f.root;this.Mxa=f.childCollectionCallback;this.oy=f.parseMetadata;this.Su=null;this.ty="none";this.Ue={};b.$a.p.constructor.call(this)};o_("CollectionTreeDataSource",b.$a,b);b.$a.prototype.oy=
function(b){return{key:b.idAttribute+"\x3d"+b.id}};b.b.la(b.$a,b.ks,"oj.CollectionTreeDataSource");b.$a.prototype.Init=function(){b.$a.p.Init.call(this)};b.b.g("CollectionTreeDataSource.prototype.Init",{Init:b.$a.prototype.Init});b.$a.prototype.tg=function(b){var a=this.Ue[b];if(a&&0<a.length)return a.length;this.lU(b,{success:function(a){return a.length}});return-1};b.b.g("CollectionTreeDataSource.prototype.getChildCount",{tg:b.$a.prototype.tg});b.$a.prototype.lU=function(b,a){this.ah(b,null,{success:function(b){a.success(b.Sa)},
error:a.error})};b.b.g("CollectionTreeDataSource.prototype.getChildCollection",{lU:b.$a.prototype.lU});b.$a.prototype.ah=function(b,a,d){a=a||{};var c=a.start?a.start:0,e=a.count?a.count:-1;if(null===b)this.Jy(null,c,e,d,null);else{var g=this;this.pP(this.qD,b,0).then(function(a){if(a){a=g.GD(a.Hr);try{g.Jy(a,c,e,d,b)}catch(k){d&&d.error&&d.error({status:k.message})}}else d&&d.error&&d.error(b)})}};b.b.g("CollectionTreeDataSource.prototype.fetchChildren",{ah:b.$a.prototype.ah});b.$a.prototype.bfa=
function(b,a,d){var c=0;d&&d.at&&(c=d.at);a=this.tG(a);b=this.qF(this,"insert",c,a,this.F6(null!=a&&0<a.length?a[a.length-1]:null,b));this.handleEvent("change",b)};b.$a.prototype.cfa=function(b,a,d){var c=0;d&&d.index&&(c=d.index);this.Kta(b);b=this.qF(this,"delete",c,this.tG(a),null);this.handleEvent("change",b)};b.$a.prototype.dfa=function(b){var a=this.Xma(b),d=null,c=null;a&&(d=a.index,c=this.tG(a.Sa));b=this.qF(this,"update",d,c,this.F6(null!=c&&0<c.length?c[c.length-1]:null,b));this.handleEvent("change",
b)};b.$a.prototype.yea=function(b){b=this.qF(this,"refresh",null,this.tG(b),null);this.handleEvent("refresh",b)};b.$a.prototype.F6=function(f,a){var d=new b.j;d.add(a);return this.f3(d,f,0,1)};b.$a.prototype.tG=function(f){var a=[],d=null;do d=this.Zna(f),null!==d&&(d!==b.$a.CX&&a.unshift(d),f=this.Yma(d));while(null!=d);return a};b.$a.CX="%!@ROOT%#@!";b.$a.prototype.$F=function(f){var a=f instanceof b.t?this.oy(f).key:f;return f?a:b.$a.CX};b.$a.prototype.e_=function(b){return this.Ue[this.$F(b)]};
b.$a.prototype.a8=function(f,a){a.on(b.ba.N.ADD,this.bfa,this);a.on(b.ba.N.REMOVE,this.cfa,this);a.on(b.ba.N.CHANGE,this.dfa,this);a.on(b.ba.N.SYNC,this.yea,this);this.Ue[this.$F(f)]=a};b.$a.prototype.Kta=function(b){b=this.$F(b);for(var a in this.Ue)if(this.Ue.hasOwnProperty(a)&&a===b){this.Ue[b].off(null,null,this);delete this.Ue[b];break}};b.$a.prototype.ura=function(b,a){for(var d=a.length,c=0;c<d;c++){var e=this.$F(a.at(c));if(b===e)return!0}return!1};b.$a.prototype.Xma=function(b){for(var a in this.Ue)if(this.Ue.hasOwnProperty(a))for(var d=
this.Ue[a],c=0;c<d.length;c++)if(d.at(c)===b)return{index:c,Sa:d};return null};b.$a.prototype.Yma=function(b){for(var a in this.Ue)if(this.Ue.hasOwnProperty(a)){var d=this.Ue[a];if(this.ura(b,d))return d}return null};b.$a.prototype.Zna=function(b){for(var a in this.Ue)if(this.Ue.hasOwnProperty(a)&&this.Ue[a]===b)return a;return null};b.$a.prototype.GD=function(b){var a=!0,d=this.e_(b);d||(a=!1,d=this.Mxa(this.qD,b),null!=d&&(this.z_(d),this.a8(b,d)));return{Sa:d,ET:a}};b.$a.prototype.qF=function(b,
a,d,c,e){return{source:b,operation:a,index:d,parent:c,data:e}};b.$a.prototype.Jy=function(b,a,d,c,e){var g=this;null===b&&((b=this.e_(null))?b={Sa:b,ET:!0}:(b={Sa:g.qD,ET:!1},g.a8(null,this.qD)));b&&g.L1(b,function(b){c.success&&c.success(g.f3(b,e,a,d))},c.error)};b.$a.prototype.f3=function(f,a,d,c){return new b.Cf(a,f,this,d,c)};b.$a.prototype.Hua=function(b,a){var d=this;return new Promise(function(c){function e(a,b,f){a<b.length?b.at(a,{deferred:!0}).then(function(l){if(l){var p=d.oy(l);if(f===
p.key){c(l);return}}a++;e(a,b,f)}):c(null)}e(0,b,a)})};b.$a.prototype.pP=function(b,a,d){var c=this;return new Promise(function(e){c.Hua(b,a).then(function(g){function h(c,g){if(c<k){var n=g.GD(b.at(c));n.Sa?g.L1(n,function(b){g.pP(b,a,d+1).then(function(a){a?e(a):(c++,h(c,g))})},null):(c++,h(c,g))}else e(null)}if(g)e({Hr:g,depth:d});else{var k=b.length;h(0,c)}})})};b.$a.prototype.L1=function(b,a,d){b.ET?a(b.Sa):(this.Su&&"none"!==this.Su&&(b.Sa.KT=this.Su,b.Sa.mW=this.ty),0<b.Sa.length||!b.Sa.Sea()?
a(b.Sa):b.Sa.fetch({success:function(b){a(b)},error:d}))};b.$a.prototype.Kx=function(b,a){var d=this;null===b?this.Jy(null,0,-1,{success:function(b){b.XW({success:function(){a.success&&a.success(b)}})}},null):this.pP(this.qD,b,0).then(function(c){c&&(c=d.GD(c.Hr),d.Jy(c,0,-1,{success:function(b){b.XW({success:function(){a.success&&a.success(b)}})}},b))})};b.b.g("CollectionTreeDataSource.prototype.fetchDescendants",{Kx:b.$a.prototype.Kx});b.$a.prototype.sort=function(b,a){var d=b.key,c=b.direction,
e=!1;d!==this.Su&&(this.Su=d,e=!0);c!==this.ty&&(this.ty=c,e=!0);if(e){"none"===this.ty&&(this.Ue={});for(var g in this.Ue)this.Ue.hasOwnProperty(g)&&this.z_(this.Ue[g])}a&&a.success&&a.success()};b.b.g("CollectionTreeDataSource.prototype.sort",{sort:b.$a.prototype.sort});b.$a.prototype.z_=function(b){b.comparator=this.Su;b.sortDirection="ascending"===this.ty?1:-1;b.sort()};b.$a.prototype.To=function(){return{key:this.Su,direction:this.ty}};b.b.g("CollectionTreeDataSource.prototype.getSortCriteria",
{To:b.$a.prototype.To});b.$a.prototype.move=function(){b.l.Dc()};b.b.g("CollectionTreeDataSource.prototype.move",{move:b.$a.prototype.move});b.$a.prototype.moveOK=function(){return"invalid"};b.b.g("CollectionTreeDataSource.prototype.moveOK",{moveOK:b.$a.prototype.moveOK});b.$a.prototype.getCapability=function(b){return"sort"===b?"default":"move"===b?"none":"batchFetch"===b||"fetchDescendants"===b?"disable":null};b.b.g("CollectionTreeDataSource.prototype.getCapability",{getCapability:b.$a.prototype.getCapability})});